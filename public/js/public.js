// Generated by CoffeeScript 1.10.0
(function() {
  $(function() {
    var $body, $intro, $introCanvas, $left, $map, $right, $window, clickLocLink, closeRight, colors, getFeature, getLocActions, getLocContent, getPoints, getUniqueFeatures, initMap, introSetup, listLocActions, listLocs, mapClick, mapMouseMove, markersLayer, maxZoom, minZoom, nycLatLng, openLocPanel, plotMarker, plotMarkers, zoomIn, zoomOut;
    $window = $(window);
    $body = $('body');
    $map = $('#map');
    $intro = $('#intro');
    $introCanvas = $('#intro');
    $right = $('#right.float');
    $left = $('#left.float');
    markersLayer = [];
    nycLatLng = {
      lat: 40.723952837100995,
      lng: -73.98725835012341
    };
    zoomIn = 15;
    zoomOut = 12;
    minZoom = 9.8;
    maxZoom = 20;
    initMap = function() {
      mapboxgl.accessToken = 'pk.eyJ1IjoiY29yZXl0ZWdlbGVyIiwiYSI6ImNpd25xZHV3cjAxMngyenFpeGd0aGxwanYifQ.quHbdI63gF-JNfVLCe_fTw';
      window.map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/coreytegeler/ciwnq6zxd004o2ppllvfpmx5x',
        center: nycLatLng,
        speed: 2,
        zoom: zoomOut,
        minZoom: minZoom,
        maxZoom: maxZoom,
        pitch: 15
      });
      return map.on('load', function() {
        getPoints();
        getFeature('boroughs');
        return $map.addClass('show');
      });
    };
    getFeature = function(featureName) {
      var url;
      url = '/geojson/' + featureName + '.json';
      $.getJSON({
        url: url,
        error: function(jqXHR, status, error) {
          console.error(jqXHR, status, error);
        },
        success: function(geojson, status, jqXHR) {
          map.addSource(featureName, {
            'type': 'geojson',
            'data': geojson
          });
          return map.addLayer({
            'id': featureName,
            'type': 'line',
            'source': featureName
          });
        }
      });
    };
    introSetup = function() {
      return $.each(map.queryRenderedFeatures(), function(i, layer) {
        var id;
        id = layer.layer.id;
        if (id === 'background') {
          console.log(layer);
        }
        return map.setLayoutProperty(id, 'visibility', 'none');
      });
    };
    getPoints = function() {
      var url;
      url = '/api/json/?type=location';
      $.ajax({
        url: url,
        error: function(jqXHR, status, error) {
          console.error(jqXHR, status, error);
        },
        success: function(response, status, jqXHR) {
          return plotMarkers(response);
        }
      });
    };
    plotMarkers = function(locs) {
      var bounds, markersArray;
      window.markers = {};
      markersArray = [];
      bounds = new mapboxgl.LngLatBounds();
      $.each(locs, function(i, loc) {
        var marker;
        marker = plotMarker(loc);
        bounds.extend(marker.geometry.coordinates);
        markersArray.push(marker);
        return markers[loc._id] = marker;
      });
      listLocs();
      map.addSource('markers', {
        'type': 'geojson',
        'data': {
          'type': 'FeatureCollection',
          'features': markersArray
        }
      });
      map.addLayer({
        'id': 'markers',
        'source': 'markers',
        'type': 'circle',
        'paint': {
          'circle-radius': 6,
          'circle-color': colors.darker
        }
      });
      map.fitBounds(bounds, {
        padding: 50,
        animate: false
      });
      map.on('mousemove', mapMouseMove);
      return map.on('click', mapClick);
    };
    plotMarker = function(loc) {
      var lat, lng, marker;
      if (!loc.point) {
        return;
      }
      lng = loc.point.longitude;
      lat = loc.point.latitude;
      marker = {
        'type': 'Feature',
        'geometry': {
          'type': 'Point',
          'coordinates': [lng, lat]
        },
        'properties': {
          'id': loc._id,
          'title': loc.name,
          'name': loc.name,
          'slug': loc.slug,
          'address': loc.pointAddress
        }
      };
      return marker;
    };
    getLocContent = function(id, title) {
      var marker, url;
      url = '/api/html/?type=location&id=' + id;
      marker = markers[id];
      $.ajax({
        url: url,
        error: function(jqXHR, status, error) {
          console.error(jqXHR, status, error);
        },
        success: function(response, status, jqXHR) {
          return openLocPanel(id, title, response, marker);
        }
      });
    };
    openLocPanel = function(id, title, response, marker) {
      var currentZoom, flyTo, latlng, pixelCoords, xOffset, zoomOffset;
      latlng = marker.geometry.coordinates;
      currentZoom = map.getZoom();
      $right.find('.title h1').html(title);
      zoomOffset = currentZoom / zoomIn;
      pixelCoords = map.project(marker.geometry.coordinates);
      xOffset = 0.375 * map._containerDimensions()[0];
      pixelCoords.x = pixelCoords.x + xOffset;
      flyTo = map.unproject(pixelCoords);
      $map.attr('data-zoom', currentZoom);
      $right.find('.content').html(response);
      getLocActions(id);
      map.flyTo({
        center: flyTo,
        curve: 1
      }, {
        bearing: 0,
        speed: .1
      });
      $right.addClass('show');
      $right.addClass('open');
      return $left.removeClass('open');
    };
    getLocActions = function(id) {
      var url;
      url = '/api/html/?type=action&filter=location&id=' + id;
      return $.ajax({
        url: url,
        error: function(jqXHR, status, error) {
          console.error(jqXHR, status, error);
        },
        success: function(content, status, jqXHR) {
          return listLocActions(content);
        }
      });
    };
    listLocActions = function(content) {
      var $actions;
      $actions = $right.find('.actions');
      return $actions.append(content);
    };
    closeRight = function(e) {
      var zoomTo;
      $right.removeClass('open');
      zoomTo = $map.attr('data-zoom');
      if (zoomTo) {
        return map.zoomTo(zoomTo);
      }
    };
    getUniqueFeatures = function(array, comparatorProperty) {
      var existingFeatureKeys, uniqueFeatures;
      existingFeatureKeys = {};
      uniqueFeatures = array.filter(function(el) {
        if (existingFeatureKeys[el.properties[comparatorProperty]]) {
          return false;
        } else {
          existingFeatureKeys[el.properties[comparatorProperty]] = true;
          return true;
        }
      });
      return uniqueFeatures;
    };
    listLocs = function(e) {
      var $leftList;
      $leftList = $left.find('ul');
      $leftList.html('');
      $.each(markers, function(id, marker) {
        var address, name, slug;
        id = marker.properties.id;
        slug = marker.properties.slug;
        name = marker.properties.name;
        address = marker.properties.address;
        return $leftList.append('<li class="loc-link" data-id="' + id + '" data-title="' + name + '"><div class="name">' + name + '</div><div class="address">' + address + '</div></li>');
      });
      return $left.addClass('open').addClass('show');
    };
    mapMouseMove = function(e) {
      var features;
      features = map.queryRenderedFeatures(e.point, {
        layers: ['markers']
      });
      if (features.length) {
        return map.getCanvas().style.cursor = 'pointer';
      } else {
        return map.getCanvas().style.cursor = '';
      }
    };
    mapClick = function(e) {
      var features, id, marker, title;
      features = map.queryRenderedFeatures(e.point, {
        layers: ['markers']
      });
      if (features.length) {
        marker = features[0];
        id = marker.properties.id;
        title = marker.properties.title;
        return getLocContent(id, title);
      }
    };
    clickLocLink = function() {
      var id, title;
      id = this.dataset.id;
      title = this.dataset.title;
      return getLocContent(id, title);
    };
    $body.on('click touchend', '.right.open .band', closeRight);
    $body.on('change', '#points input', listLocs);
    $body.on('click', '.loc-link', clickLocLink);
    colors = {
      white: $('#palette .white').css('color'),
      light: $('#palette .light').css('color'),
      medium: $('#palette .medium').css('color'),
      dark: $('#palette .dark').css('color'),
      darker: $('#palette .darker').css('color'),
      black: $('#palette .black').css('color'),
      yellow: $('#palette .yellow').css('color')
    };
    return initMap();
  });

}).call(this);
