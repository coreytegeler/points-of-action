// Generated by CoffeeScript 1.10.0
(function() {
  $(function() {
    var $body, $intro, $left, $map, $palette, $right, $window, adjustMapWrap, begin, centerPoint, clickLocLink, clickPoint, closeRight, colors, createMask, getFeature, getLocActions, getLocContent, getPoints, getUniqueFeatures, getUrl, init, initMap, introSetup, listLocActions, listModel, mapMouseMove, markersLayer, maxZoom, minZoom, nycLatLng, openLocPanel, plotMarker, plotMarkers, readUrl, toggleAside, watchAsides, winResize, winResized, zoomIn, zoomOut;
    $window = $(window);
    $body = $('body');
    $map = $('#map');
    $intro = $('#intro');
    $right = $('aside#right');
    $left = $('aside#left');
    markersLayer = [];
    window.markers = {};
    nycLatLng = {
      lat: 40.723952837100995,
      lng: -73.98725835012341
    };
    zoomIn = 15;
    zoomOut = 12;
    minZoom = 9.8;
    maxZoom = 20;
    init = function() {
      readUrl();
      initMap();
      return watchAsides();
    };
    initMap = function() {
      mapboxgl.accessToken = 'pk.eyJ1IjoiY29yZXl0ZWdlbGVyIiwiYSI6ImNpd25xNjU0czAyeG0yb3A3cjdkc2NleHAifQ.EJAjj38qZXzIylzax3EMWg';
      window.map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/coreytegeler/ciwnq6zxd004o2ppllvfpmx5x',
        center: nycLatLng,
        speed: 2,
        zoom: zoomOut,
        minZoom: minZoom,
        maxZoom: maxZoom,
        pitch: 15
      });
      return map.on('load', function() {
        getPoints();
        introSetup();
        createMask();
        adjustMapWrap();
        return winResize();
      });
    };
    getFeature = function(featureName) {
      var url;
      url = '/geojson/' + featureName + '.json';
      return $.ajax({
        url: url,
        datatype: 'json',
        error: function(jqXHR, status, error) {
          console.error(jqXHR, status, error);
        },
        success: function(geojson, status, jqXHR) {
          return geojson;
        }
      });
    };
    createMask = function() {
      return $.when(getFeature('nyc'), getFeature('boroughs')).done(function(nyc, boroughs) {
        var boroughsFeature, mask, nycBounds, nycBoundsBuffer, nycFeature, nycPoly, nycPolyBuffer;
        nyc = nyc[0];
        boroughs = boroughs[0];
        nycFeature = turf.combine(nyc).features[0];
        boroughsFeature = turf.combine(boroughs);
        nycBounds = turf.bbox(nycFeature);
        nycPoly = turf.bboxPolygon(nycBounds);
        nycBoundsBuffer = turf.buffer(nycPoly, 20, 'miles');
        nycPolyBuffer = turf.buffer(nycPoly, 100, 'miles');
        mask = turf.difference(nycPolyBuffer, nycFeature);
        map.setMaxBounds(turf.bbox(nycBoundsBuffer));
        map.addSource('nyc-mask', {
          'type': 'geojson',
          'data': mask
        });
        return map.addLayer({
          'id': 'nyc-mask',
          'type': 'fill',
          'source': 'nyc-mask',
          'paint': {
            'fill-color': '#addef0',
            'fill-opacity': 0.999
          }
        });
      });
    };
    introSetup = function() {};
    getPoints = function() {
      var url;
      url = '/api/json/?model=location';
      $.ajax({
        url: url,
        error: function(jqXHR, status, error) {
          console.error(jqXHR, status, error);
        },
        success: function(response, status, jqXHR) {
          var id;
          plotMarkers(response);
          if ($right.is('.open')) {
            id = $right.data('id');
            return centerPoint(id);
          }
        }
      });
    };
    plotMarkers = function(locs) {
      var bounds, markersArray;
      markersArray = [];
      bounds = new mapboxgl.LngLatBounds();
      $.each(locs, function(i, loc) {
        var marker;
        marker = plotMarker(loc, i);
        bounds.extend(marker.geometry.coordinates);
        markersArray.push(marker);
        return markers[loc._id] = marker;
      });
      map.addSource('markers', {
        'type': 'geojson',
        'data': {
          'type': 'FeatureCollection',
          'features': markersArray
        }
      });
      map.addLayer({
        'id': 'markers',
        'source': 'markers',
        'type': 'circle',
        'paint': {
          'circle-radius': 6,
          'circle-color': 'transparent'
        }
      });
      map.fitBounds(bounds, {
        padding: 50,
        animate: false
      });
      map.on('mousemove', mapMouseMove);
      $body.addClass('intro');
      return begin();
    };
    plotMarker = function(loc, i) {
      var $point, lat, lng, marker, point;
      if (!loc.point) {
        return;
      }
      lng = loc.point.longitude;
      lat = loc.point.latitude;
      point = document.createElement('div');
      new mapboxgl.Marker(point).setLngLat([lng, lat]).addTo(map);
      $point = $(point).addClass('point').attr('data-id', loc._id).attr('data-title', loc.name).attr('data-name', loc.name).attr('data-slug', loc.slug).attr('data-address', loc.pointAddress);
      setTimeout(function() {
        return $point.addClass('show');
      }, 10 * i);
      marker = {
        'type': 'Feature',
        'geometry': {
          'type': 'Point',
          'coordinates': [lng, lat]
        },
        'properties': {
          'id': loc._id,
          'title': loc.name,
          'name': loc.name,
          'slug': loc.slug,
          'address': loc.pointAddress
        }
      };
      return marker;
    };
    begin = function() {
      $body.removeClass('intro');
      $body.addClass('map');
      return $left.addClass('show').addClass('open');
    };
    getLocContent = function(id, title) {
      var url;
      url = '/api/html/?model=location&id=' + id;
      $.ajax({
        url: url,
        error: function(jqXHR, status, error) {
          console.error(jqXHR, status, error);
        },
        success: function(response, status, jqXHR) {
          return openLocPanel(id, title, response);
        }
      });
    };
    openLocPanel = function(id, title, response) {
      $right.find('header h2').html(title);
      $right.find('.band a .text').html('<label>Location:</label>' + title);
      if (!$.isEmptyObject(markers)) {
        centerPoint(id);
      }
      getLocActions(id);
      $right.find('.content').html(response);
      $right.attr('data-id', id);
      $right.addClass('show');
      $right.addClass('open');
      $left.removeClass('open');
      return adjustMapWrap();
    };
    centerPoint = function(id) {
      var currentZoom, flyTo, latlng, marker, zoomOffset;
      marker = markers[id];
      latlng = marker.geometry.coordinates;
      currentZoom = map.getZoom();
      zoomOffset = currentZoom / zoomIn;
      flyTo = marker.geometry.coordinates;
      $map.attr('data-zoom', currentZoom);
      return map.flyTo({
        center: flyTo,
        curve: 1
      }, {
        bearing: 0,
        speed: .1
      });
    };
    getLocActions = function(id) {
      var url;
      url = '/api/html/?model=action&filter=location&id=' + id;
      return $.ajax({
        url: url,
        error: function(jqXHR, status, error) {
          console.error(jqXHR, status, error);
        },
        success: function(content, status, jqXHR) {
          return listLocActions(id, content);
        }
      });
    };
    listLocActions = function(id, content) {
      var $actions, $content;
      $content = $(content);
      $actions = $right.find('.actions');
      $actions.append($content);
      return $content.imagesLoaded().progress(function(inst, image) {
        var $image, $img;
        $img = $(image.img);
        $image = $img.parent();
        return $image.addClass('loaded');
      });
    };
    closeRight = function(e) {
      var zoomTo;
      $right.removeClass('open');
      zoomTo = $map.attr('data-zoom');
      if (zoomTo) {
        return map.zoomTo(zoomTo);
      }
    };
    getUniqueFeatures = function(array, comparatorProperty) {
      var existingFeatureKeys, uniqueFeatures;
      existingFeatureKeys = {};
      uniqueFeatures = array.filter(function(el) {
        if (existingFeatureKeys[el.properties[comparatorProperty]]) {
          return false;
        } else {
          existingFeatureKeys[el.properties[comparatorProperty]] = true;
          return true;
        }
      });
      return uniqueFeatures;
    };
    listModel = function(e) {
      var $a, $row, model, url;
      e.preventDefault();
      $a = $(this);
      $row = $a.parents('.row');
      model = $row.attr('data-model');
      url = '/api/json/?model=' + model;
      console.log(url);
      return $.ajax({
        url: url,
        error: function(jqXHR, status, error) {
          console.error(jqXHR, status, error);
        },
        success: function(list, status, jqXHR) {
          return $.each(list, function(i, item) {
            var $ul;
            $ul = $row.parents('.group').find('.bricks.' + model);
            return $ul.append('<div class="brick">' + item.name + '</div>');
          });
        }
      });
    };
    mapMouseMove = function(e) {
      var features;
      features = map.queryRenderedFeatures(e.point, {
        layers: ['markers']
      });
      if (features.length) {
        return map.getCanvas().style.cursor = 'pointer';
      } else {
        return map.getCanvas().style.cursor = '';
      }
    };
    clickLocLink = function(e) {
      var id, title;
      e.preventDefault();
      id = this.dataset.id;
      title = this.dataset.title;
      return getLocContent(id, title);
    };
    clickPoint = function(e) {
      var id, title;
      id = $(this).attr('data-id');
      title = $(this).attr('data-title');
      return getLocContent(id, title);
    };
    getUrl = function(model, slug) {
      var root;
      root = $body.data('root');
      root = '/';
      return root + model + '/' + slug;
    };
    readUrl = function() {
      var id, model;
      id = $body.data('id');
      model = $body.data('model');
      switch (model) {
        case 'location':
          getLocContent(id);
          break;
      }
    };
    watchAsides = function() {};
    toggleAside = function(e) {
      var $aside, $band;
      $band = $(this);
      $aside = $band.parents('aside');
      $aside.toggleClass('open');
      if ($aside.is('#right.open')) {
        $left.removeClass('open');
      }
      return adjustMapWrap();
    };
    adjustMapWrap = function() {
      var dur, leftWidth, mapWidth, marginLeft, marginRight, rightWidth;
      leftWidth = $left.innerWidth();
      rightWidth = $right.innerWidth();
      mapWidth = $window.innerWidth();
      marginLeft = 0;
      marginRight = 0;
      if ($left.is('.open')) {
        mapWidth -= leftWidth;
        marginLeft = leftWidth;
        dur = $left.css('transition-duration');
      }
      if ($right.is('.open')) {
        mapWidth -= rightWidth;
        marginRight = rightWidth;
      }
      return $map.css({
        width: mapWidth,
        marginLeft: marginLeft,
        marginRight: marginRight
      });
    };
    winResize = function() {
      $('aside').addClass('static');
      adjustMapWrap();
      clearTimeout(window.timeout);
      return window.timeout = setTimeout(winResized, 300);
    };
    winResized = function() {
      return $('aside').removeClass('static');
    };
    $body.on('click', '.locations ul li.loc a', clickLocLink);
    $body.on('click', '#map .point', clickPoint);
    $body.on('click touchend', '.band', toggleAside);
    $body.on('click touchend', '#begin', begin);
    $body.on('click touchend', '.contents a.model', listModel);
    $window.on('resize', winResize);
    $palette = $('#palette');
    colors = {
      white: $palette.find('.white').css('color'),
      light: $palette.find('.light').css('color'),
      medium: $palette.find('.medium').css('color'),
      dark: $palette.find('.dark').css('color'),
      darker: $palette.find('.darker').css('color'),
      black: $palette.find('.black').css('color'),
      yellow: $palette.find('.yellow').css('color')
    };
    return init();
  });

}).call(this);
